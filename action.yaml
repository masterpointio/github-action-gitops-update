name: gitops-update
description: Reusable GitHub Action to update a YAML file and commit the result
author: hello@masterpoint.io

inputs:
  new_value:
    description: New value that should replace the existing value at the given YAML path
    required: true
  yaml_key_path:
    description: Path to the YAML key that should be updated within the given YAML file
    required: true
  yaml_file_path:
    description: Path to the YAML file that should be updated
    required: true
  commit_message:
    description: Commit message that should be used when committing the changes
    required: true
  commit_username:
    description: The username of the user that will execute the commit.
    default: github-actions
    required: false
  commit_email:
    description: The email of the user that will execute the commit.
    default: github-actions@github.com
    required: false
  target_branch:
    description: The branch that should be pushed to
    default: ${{ github.event.repository.default_branch }}
    required: false
  github_token:
    description: The GitHub token used to commit and push the gitops changes (unnecessary if you don't have branch protections enabled on your target branch)
    default: ${{ github.token }}
    required: false

runs:
  using: composite
  steps:
    - name: Checkout
      uses: actions/checkout@v3
    - name: Update YAML file with given value
      uses: mikefarah/yq@v4.34.1
      with:
        # Have to include a goofy diff / patch workaround to deal yq removing all whitespace newlines
        # See https://github.com/mikefarah/yq/issues/515#issuecomment-1113957629
        cmd: yq -i '${{ inputs.yaml_key_path }} = "${{ inputs.new_value }}"' '${{ inputs.yaml_file_path }}' | diff -B '${{ inputs.yaml_file_path }}' - | patch '${{ inputs.yaml_file_path }}' -
    - name: Commit files
      shell: bash
      run: |
        echo "Committing and pushing changes"
        git config user.name ${{ inputs.commit_username }}
        git config user.email ${{ inputs.commit_email }}
        git add ${{ inputs.yaml_file_path }}
        git commit --allow-empty -m "ci(gitops): ${{ inputs.commit_message }}"
        git push -u origin ${{ inputs.target_branch }}
